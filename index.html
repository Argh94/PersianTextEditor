<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ویرایشگر متن فارسی</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Fonts -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Sahel/Sahel.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Samim/Samim.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Shabnam/Shabnam.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Tanha/Tanha.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Titr/Titr.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Nazanin/Nazanin.css" rel="stylesheet">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Nastaliq/Nastaliq.css" rel="stylesheet">
  <!-- Pickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Vazir', sans-serif;
      direction: rtl;
      background: #212529;
      color: #fff;
      margin: 0;
      min-height: 100vh;
    }
    .light-theme {
      background: linear-gradient(135deg, #e0e7ff, #f3f4f6);
      color: #333;
    }
    .light-theme #editor {
      background: #fff;
      border: 1px solid #ccc;
      color: #333;
    }
    .light-theme .form-select, .light-theme .btn {
      background-color: #e9ecef;
      color: #333;
      border-color: #ccc;
    }
    .light-theme .status-bar {
      color: #555;
    }
    .light-theme .preview {
      background: #f8f9fa;
      border-color: #4CAF50;
    }
    .light-theme .preview-header {
      color: #333;
    }
    #editor {
      min-height: 350px;
      background: #343a40;
      border: 1px solid #555;
      padding: 15px;
      border-radius: 8px;
      outline: none;
      color: #fff;
    }
    .preview {
      min-height: 200px;
      background: #fff;
      color: #333;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      padding: 15px;
    }
    .preview img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .preview-header {
      color: #fff;
      font-size: 1rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .toolbar button, .toolbar select {
      margin: 4px;
    }
    .form-select, .btn {
      background-color: #495057;
      color: #fff;
      border-color: #666;
    }
    .form-select option {
      background-color: #212529;
      color: #fff;
    }
    .btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }
    .status-bar {
      font-size: 0.9rem;
      margin-top: 10px;
      color: #ccc;
    }
    #alertContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      z-index: 9999;
    }
    .alert {
      animation: slideIn 0.5s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .footer {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
    }
    .footer a {
      color: #fff;
      text-decoration: none;
    }
    .light-theme .footer a {
      color: #333;
    }
    .footer a:hover {
      color: #4CAF50;
    }
    .emoji-picker {
      position: absolute;
      background: #343a40;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 200px;
    }
    .light-theme .emoji-picker {
      background: #e9ecef;
    }
    .emoji-picker span {
      cursor: pointer;
      font-size: 1.5rem;
    }
    .emoji-picker span:hover {
      transform: scale(1.2);
    }
  </style>
</head>
<body>
<div id="alertContainer" class="container"></div>
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">✍️ ویرایشگر متن آنلاین</h4>
    <button class="btn btn-sm btn-outline-light" onclick="toggleTheme()" aria-label="تغییر تم">
      <i id="themeIcon" class="bi bi-moon"></i>
    </button>
  </div>
  <div class="toolbar d-flex flex-wrap mb-3">
    <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="execCmd('bold')" aria-label="بولد"><i class="bi bi-type-bold"></i></button>
    <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="execCmd('italic')" aria-label="ایتالیک"><i class="bi bi-type-italic"></i></button>
    <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="execCmd('underline')" aria-label="زیرخط"><i class="bi bi-type-underline"></i></button>
    <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="execCmd('justifyRight')" aria-label="راست‌چین"><i class="bi bi-text-right"></i></button>
    <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="execCmd('justifyCenter')" aria-label="وسط‌چین"><i class="bi bi-text-center"></i></button>
    <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="execCmd('justifyLeft')" aria-label="چپ‌چین"><i class="bi bi-text-left"></i></button>
    <button class="btn btn-outline-success btn-sm me-2 mb-2" onclick="execCmd('insertOrderedList')" aria-label="لیست شماره‌دار"><i class="bi bi-list-ol"></i></button>
    <button class="btn btn-outline-success btn-sm me-2 mb-2" onclick="execCmd('insertUnorderedList')" aria-label="لیست نقطه‌دار"><i class="bi bi-list-ul"></i></button>
    <select class="form-select form-select-sm w-auto me-2 mb-2" onchange="execCmd('fontSize', this.value)" aria-label="اندازه فونت">
      <option value="">اندازه</option>
      <option value="1">8</option>
      <option value="2">10</option>
      <option value="3">12</option>
      <option value="4">14</option>
      <option value="5">16</option>
      <option value="6">20</option>
      <option value="7">24</option>
    </select>
    <select class="form-select form-select-sm w-auto me-2 mb-2" onchange="execCmd('fontName', this.value)" aria-label="فونت">
      <option value="">فونت</option>
      <option value="Vazir">وزیر</option>
      <option value="Sahel">ساحل</option>
      <option value="Samim">صمیم</option>
      <option value="Shabnam">شبنم</option>
      <option value="Tanha">تنها</option>
      <option value="B Titr">تیتر</option>
      <option value="B Nazanin">نازنین</option>
      <option value="IranNastaliq">نستعلیق</option>
    </select>
    <div id="fontColorPicker" class="ms-2 mb-2"></div>
    <div id="bgColorPicker" class="ms-2 mb-2"></div>
    <button class="btn btn-outline-warning btn-sm me-2 mb-2" onclick="execCmd('undo')" aria-label="بازگشت"><i class="bi bi-arrow-90deg-left"></i></button>
    <button class="btn btn-outline-warning btn-sm me-2 mb-2" onclick="execCmd('redo')" aria-label="جلو"><i class="bi bi-arrow-90deg-right"></i></button>
    <button class="btn btn-outline-light btn-sm me-2 mb-2" onclick="copyToClipboard()" aria-label="کپی"><i class="bi bi-clipboard"></i></button>
    <button class="btn btn-outline-danger btn-sm me-2 mb-2" onclick="clearEditor()" aria-label="پاک کردن"><i class="bi bi-trash"></i></button>
    <button class="btn btn-outline-info btn-sm me-2 mb-2" onclick="loadContent()" aria-label="بارگذاری"><i class="bi bi-upload"></i></button>
    <button class="btn btn-outline-success btn-sm me-2 mb-2" onclick="promptSaveFormat()" aria-label="ذخیره"><i class="bi bi-download"></i></button>
    <button class="btn btn-outline-info btn-sm me-2 mb-2" onclick="showEmojiPicker()" aria-label="شکلک"><i class="bi bi-emoji-smile"></i></button>
    <button class="btn btn-outline-info btn-sm me-2 mb-2" onclick="document.getElementById('imageInput').click()" aria-label="تصویر"><i class="bi bi-image"></i></button>
    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="insertImage()">
    <button class="btn btn-outline-light btn-sm me-2 mb-2" onclick="toggleFullscreen()" aria-label="تمام‌صفحه"><i class="bi bi-arrows-fullscreen"></i></button>
    <button class="btn btn-outline-warning btn-sm me-2 mb-2" onclick="checkSpelling()" aria-label="املا"><i class="bi bi-spellcheck"></i></button>
    <select class="form-select form-select-sm w-auto me-2 mb-2" onchange="insertTemplate(this.value)" aria-label="قالب">
      <option value="">قالب</option>
      <option value="letter">نامه رسمی</option>
      <option value="resume">رزومه</option>
      <option value="poem">شعر</option>
      <option value="note">یادداشت روزانه</option>
      <option value="invitation">دعوت‌نامه</option>
      <option value="story">داستان کوتاه</option>
      <option value="blog">پست وبلاگ</option>
      <option value="plan">برنامه روزانه</option>
    </select>
  </div>
  <div id="editor" contenteditable="true" aria-label="ویرایشگر متن"></div>
  <div class="input-group mt-3 mb-3">
    <span class="input-group-text"><i class="bi bi-file-earmark-arrow-up"></i></span>
    <input type="file" class="form-control" id="fileInput" accept=".txt" onchange="loadFromFile()" aria-label="آپلود فایل">
  </div>
  <div class="mt-3">
    <h5 class="preview-header"><i class="bi bi-eye"></i> پیش‌نمایش زنده</h5>
    <div class="preview p-3 text-dark border rounded" id="preview"></div>
  </div>
  <div class="status-bar mt-2" id="statusBar">کلمات: 0 | کاراکتر: 0</div>
  <div class="footer">
    <a href="https://github.com/Argh94" target="_blank"><i class="bi bi-github"></i> درباره من</a>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
<script>
  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const statusBar = document.getElementById('statusBar');
  const alertContainer = document.getElementById('alertContainer');
  const themeIcon = document.getElementById('themeIcon');
  let currentBgColor = '#ffffff';

  function execCmd(cmd, val = null) {
    try {
      document.execCommand(cmd, false, val);
      editor.focus();
      updateStatus();
    } catch (e) {
      console.error(`Error in ${cmd}:`, e);
      showAlert('خطا در اجرا.', 'danger');
    }
  }

  function clearEditor() {
    editor.innerHTML = '';
    preview.innerHTML = '';
    currentBgColor = '#ffffff';
    preview.style.backgroundColor = currentBgColor;
    updateStatus();
    showAlert('محتوا پاک شد.', 'danger');
  }

  function copyToClipboard() {
    try {
      navigator.clipboard.writeText(editor.innerText);
      showAlert('متن کپی شد.', 'success');
    } catch (e) {
      console.error('Error in copy:', e);
      showAlert('خطا در کپی.', 'danger');
    }
  }

  function loadContent() {
    const saved = localStorage.getItem("editorContent");
    if (saved) {
      editor.innerHTML = saved;
      preview.innerHTML = saved;
      updateStatus();
      showAlert('محتوا بارگذاری شد.', 'info');
    } else {
      showAlert('محتوایی وجود ندارد.', 'warning');
    }
  }

  function downloadText() {
    try {
      const blob = new Blob([editor.innerText], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "text.txt";
      link.click();
      showAlert('فایل TXT دانلود شد.', 'success');
    } catch (e) {
      console.error('Error in downloadText:', e);
      showAlert('خطا در دانلود.', 'danger');
    }
  }

  function saveAsPDF() {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.addFont('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/Vazir.ttf', 'Vazir', 'normal');
      doc.setFont('Vazir');
      doc.setFontSize(12);
      doc.text(editor.innerText, 10, 10, { align: 'right', maxWidth: 190 });
      doc.save('text.pdf');
      showAlert('فایل PDF دانلود شد.', 'success');
    } catch (e) {
      console.error('Error in saveAsPDF:', e);
      showAlert('خطا در PDF.', 'danger');
    }
  }

  function promptSaveFormat() {
    const format = prompt('ذخیره به‌صورت PDF یا TXT؟', 'TXT');
    if (format?.toLowerCase() === 'pdf') saveAsPDF();
    else if (format?.toLowerCase() === 'txt') downloadText();
    else showAlert('فرمت نامعتبر.', 'warning');
  }

  function loadFromFile() {
    try {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        editor.innerText = e.target.result;
        preview.innerHTML = e.target.result;
        updateStatus();
        showAlert('فایل بارگذاری شد.', 'info');
      };
      reader.readAsText(file);
    } catch (e) {
      console.error('Error in loadFromFile:', e);
      showAlert('خطا در بارگذاری.', 'danger');
    }
  }

  function insertImage() {
    try {
      const fileInput = document.getElementById('imageInput');
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        editor.appendChild(img);
        updateStatus();
        showAlert('تصویر درج شد.', 'success');
      };
      reader.readAsDataURL(file);
    } catch (e) {
      console.error('Error in insertImage:', e);
      showAlert('خطا در تصویر.', 'danger');
    }
  }

  function updateStatus() {
    try {
      const text = editor.innerText.trim();
      const words = text ? text.split(/\s+/).length : 0;
      const chars = text.length;
      statusBar.textContent = `کلمات: ${words} | کاراکتر: ${chars}`;
      preview.innerHTML = editor.innerHTML;
      preview.style.backgroundColor = currentBgColor;
    } catch (e) {
      console.error('Error in updateStatus:', e);
      showAlert('خطا در وضعیت.', 'danger');
    }
  }

  function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-2`;
    alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    alertContainer.appendChild(alert);
    setTimeout(() => alert.remove(), 4000);
  }

  function toggleTheme() {
    try {
      document.body.classList.toggle('light-theme');
      const isLight = document.body.classList.contains('light-theme');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      themeIcon.className = isLight ? 'bi bi-sun' : 'bi bi-moon';
      showAlert('تم تغییر کرد.', 'info');
    } catch (e) {
      console.error('Error in toggleTheme:', e);
      showAlert('خطا در تم.', 'danger');
    }
  }

  function showEmojiPicker() {
    try {
      const emojis = ['😊', '👍', '❤️', '🚀', '🌟', '😂', '😍', '😎', '🐱', '🐶', '🍎', '🍕', '🌈', '⚽', '🎮', '🎸', '✨', '🔥', '💡', '🎉'];
      const emojiList = emojis.map(e => `<span onclick="insertEmoji('${e}')" style="cursor: pointer; font-size: 1.5rem; margin: 5px;">${e}</span>`).join('');
      if (document.querySelector('.emoji-picker')) document.querySelector('.emoji-picker').remove();
      editor.insertAdjacentHTML('beforeend', `<div class="emoji-picker">${emojiList}</div>`);
    } catch (e) {
      console.error('Error in showEmojiPicker:', e);
      showAlert('خطا در شکلک‌ها.', 'danger');
    }
  }

  function insertEmoji(emoji) {
    try {
      document.querySelector('.emoji-picker').remove();
      document.execCommand('insertText', false, emoji);
      editor.focus();
      updateStatus();
    } catch (e) {
      console.error('Error in insertEmoji:', e);
      showAlert('خطا در درج شکلک.', 'danger');
    }
  }

  function toggleFullscreen() {
    try {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        showAlert('تمام‌صفحه فعال شد.', 'info');
      } else {
        document.exitFullscreen();
        showAlert('تمام‌صفحه غیرفعال شد.', 'info');
      }
    } catch (e) {
      console.error('Error in toggleFullscreen:', e);
      showAlert('خطا در تمام‌صفحه.', 'danger');
    }
  }

  function checkSpelling() {
    try {
      const dict = { 'می شه': 'میشه', 'نمیدونم': 'نمی‌دونم', 'خوبست': 'خوبه', 'باش': 'باشه' };
      let text = editor.innerHTML;
      for (let wrong in dict) {
        text = text.replace(new RegExp(`\\b${wrong}\\b`, 'g'), `<span style="color: red; text-decoration: underline;">${dict[wrong]}</span>`);
      }
      editor.innerHTML = text;
      preview.innerHTML = text;
      showAlert('املا بررسی شد.', 'info');
    } catch (e) {
      console.error('Error in checkSpelling:', e);
      showAlert('خطا در املا.', 'danger');
    }
  }

  function insertTemplate(template) {
    try {
      const templates = {
        letter: `<div style="font-family: Vazir; text-align: right;"><p style="font-size: 14px;">بسمه تعالی</p><p style="font-size: 14px;">جناب آقای/خانم ...<br>با سلام و احترام،</p><p style="font-size: 14px;">بدین‌وسیله ...<br>با تشکر،<br>امضا</p></div>`,
        resume: `<div style="font-family: Sahel; text-align: right;"><h3 style="text-align: center; color: #4CAF50;">رزومه</h3><p style="font-size: 14px;"><b>نام:</b> ...<br><b>تحصیلات:</b> ...<br><b>مهارت‌ها:</b> ...<br><b>تجربیات کاری:</b> ...</p></div>`,
        poem: `<div style="font-family: IranNastaliq; text-align: center;"><p style="font-size: 18px; line-height: 2;">شعری زیبا<br>در این‌جا شعر خود را با فونت نستعلیق بنویسید...</p></div>`,
        note: `<div style="font-family: Shabnam; text-align: right;"><p style="font-size: 14px;"><b>یادداشت روزانه</b><br>تاریخ: ...<br>امروز ...<br>برنامه‌های فردا: ...</p></div>`,
        invitation: `<div style="font-family: B Nazanin; text-align: center;"><h4 style="color: #D81B60;">دعوت‌نامه</h4><p style="font-size: 16px;">با کمال افتخار از شما دعوت می‌کنیم تا در مراسم ... شرکت کنید.<br>زمان: ...<br>مکان: ...</p></div>`,
        story: `<div style="font-family: Tanha; text-align: right;"><h4 style="color: #0288D1;">داستان کوتاه</h4><p style="font-size: 14px; line-height: 1.8;">روزی روزگاری، در سرزمینی دور ...<br>داستان خود را اینجا بنویسید.</p></div>`,
        blog: `<div style="font-family: Samim; text-align: right;"><h3 style="color: #388E3C;">عنوان پست وبلاگ</h3><p style="font-size: 14px;">مقدمه: ...<br>بدنه: ...<br>نتیجه‌گیری: ...</p></div>`,
        plan: `<div style="font-family: B Titr; text-align: right;"><h4 style="color: #F57C00;">برنامه روزانه</h4><p style="font-size: 14px;">- ۸:۰۰ صبح: ...<br>- ۱۲:۰۰ ظهر: ...<br>- ۶:۰۰ عصر: ...</p></div>`
      };
      if (templates[template]) {
        editor.innerHTML = templates[template];
        preview.innerHTML = templates[template];
        updateStatus();
        showAlert('قالب اضافه شد.', 'success');
      }
    } catch (e) {
      console.error('Error in insertTemplate:', e);
      showAlert('خطا در قالب.', 'danger');
    }
  }

  editor.addEventListener('input', updateStatus);
  window.addEventListener('load', () => {
    try {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        themeIcon.className = 'bi bi-sun';
      }
      editor.focus();
      updateStatus();
    } catch (e) {
      console.error('Error in load:', e);
      showAlert('خطا در بارگذاری.', 'danger');
    }
  });

  try {
    const fontColorPickr = Pickr.create({
      el: '#fontColorPicker',
      theme: 'class
